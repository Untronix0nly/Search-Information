usb эс би универсальная шина интерфейс для подключения периферийных устройств вычислительной технике получил широчайшее распространение фактически стал основным интерфейсом подключения периферии бытовой цифровой технике интерфейс позволяет не только обмениваться данными но обеспечивать электропитание периферийного устройства сетевая архитектура позволяет подключать большое количество периферии даже устройству одним разъёмом usb разработка спецификаций usb производится рамках международной некоммерческой организации usb implementers forum usb if объединяющей разработчиков производителей оборудования шиной usb процессе развития выработано несколько версий спецификаций тем не менее разработчикам удалось сохранить высокую степень совместимости оборудования разных поколений спецификация интерфейса охватывает беспрецедентно широкий круг вопросов подключения взаимодействия периферийных устройств вычислительной системой унификацию разъёмов кабелей нормирование протоколы обмена данными унификацию драйверов устройств история первые спецификации для usb были представлены годах разработка usb поддерживалась фирмами intel microsoft philips us robotics usb стал общим знаменателем под тремя не связанными друг другом стремлениями разных компаний расширение компьютера на тот момент для подключения внешних периферийных устройств персональному компьютеру использовалось несколько традиционных интерфейсов ps порт параллельный порт порт для подключения джойстика scsi появлением новых внешних устройств разрабатывали новый разъём предполагалось что usb заменит их все заодно подхлестнёт разработку нетрадиционных устройств подключить компьютеру мобильный телефон то время мобильные сети переходили на цифровую передачу голоса ни один из имеющихся интерфейсов не годился для передачи телефона на компьютер как речи так данных простота для пользователя старые интерфейсы например com параллельный lpt порты были крайне просты для разработчика но не давали настоящего подключи работай требовались новые механизмы взаимодействия компьютера низко внешними устройствами возможно более сложные для конструкторов но надёжные дружественные пригодные горячему подключению поддержка usb вышла виде патча windows oem service release дальнейшем она вошла стандартную поставку windows первые годы устройств было мало поэтому шину шутку называли useless serial bus бесполезная шина впрочем производители быстро осознали пользу usb уже году большинство принтеров сканеров работали новым интерфейсом hewlett packard intel lucent ныне alcatel lucent microsoft nec philips совместно выступили инициативой по разработке более скоростной версии usb спецификация usb была опубликована апреле года конце года эта версия была usb implementers forum usb является обратно совместимой со всеми предыдущими версиями usb следует отметить что начале годов корпорация apple отдавала приоритет шине firewire разработке которой она принимала активное участие ранние модели ipod были оснащены только интерфейсом firewire usb отсутствовал впоследствии компания отказалась от firewire пользу usb оставив некоторых моделях firewire только для подзарядки однако часть выпускавшихся клавиатур мышей начиная со второй половины годов имела интерфейс usb поддержка usb корпоративном сегменте началась середины это позволило загружаться флеш дисков например для переустановки ос пропала надобность ps клавиатуре современные настольные материнские платы поддерживают более usb портов подавляющем большинстве современных ноутбуков com lpt портов нет всё чаще появляются настольные компьютеры без com портов пока происходило распространение usb портов второй версии производители внешних жёстких дисков уже упёрлись ограничение usb по току по скорости потребовался новый стандарт который вышел году уложиться старые провода не удалось добавили новых первые материнские платы поддержкой usb вышли году году usb стал массовым также имеются платы расширения добавляющие поддержку usb старых компьютерах уже первые годы обнаружился серьёзный конструктивный недостаток разъёма usb он асимметричен но не показывает какой стороной подключать тому же на сцену вышли смартфоны на них не стоит делать много разъёмов так телефонах samsung между пятью штырями microusb добавили шесть новых обе эти проблемы решил симметричный разъём usb появившийся году одни провода продублированы на обеих сторонах назначении других контроллеры договариваются при подключении заодно usb имеет несколько резервных проводов чтобы передавать через него например hdmi данный момент usb применяется основном мобильных устройствах основные сведения кабель usb до включительно состоит из медных проводников проводника питания проводника данных витой паре заземлённой оплётки экрана кабели usb ориентированы то есть имеют физически разные наконечники устройству тип хосту тип возможна реализация usb устройства без кабеля со встроенным корпус наконечником хосту возможно неразъёмное встраивание кабеля устройство как мышь стандарт запрещает это для устройств full high speed но производители его нарушают существуют хотя запрещены стандартом пассивные usb удлинители имеющие разъёмы от хоста хосту помощью кабелей формируется интерфейс между usb устройствами usb хостом качестве хоста выступает программно управляемый usb контроллер который обеспечивает всего интерфейса контроллер как правило интегрирован микросхему южного моста хотя может быть исполнен отдельном корпусе соединение контроллера внешними устройствами происходит через usb концентратор другие названия хаб разветвитель силу того что usb шина имеет древовидную топологию концентратор самого верхнего уровня называется корневым root hub он встроен usb контроллер является его неотъемлемой частью для подключения внешних устройств usb концентратору нём предусмотрены порты заканчивающиеся разъёмами разъёмам помощью кабельного хозяйства могут подключаться usb устройства либо usb хабы нижних уровней такие хабы активные электронные устройства пассивных не бывает обслуживающие несколько собственных usb портов помощью usb концентраторов допускается до пяти уровней каскадирования не считая корневого сам usb интерфейс не позволяет соединять между собой два компьютера хост устройства это возможно лишь при использовании специальной электроники имеющей два usb входа мост например эмулирующей два соединённых ethernet адаптера по одному для каждой из сторон либо использующие по для обмена файлами устройства могут быть запитаны от шины но могут требовать внешний источник питания по умолчанию устройствам гарантируется ток до ма после согласования хост контроллером до ма поддерживается дежурный режим для устройств разветвителей по команде шины со снятием основного питания при сохранении дежурного питания включением по команде шины usb поддерживает горячее подключение отключение устройств это достигнуто увеличенной длиной заземляющего контакта разъёма по отношению сигнальным при подключении разъёма usb первыми замыкаются заземляющие контакты потенциалы корпусов двух устройств становятся равны дальнейшее соединение сигнальных проводников не приводит перенапряжениям даже если устройства питаются от разных фаз силовой трёхфазной сети на логическом уровне устройство usb поддерживает транзакции приёма передачи данных каждый пакет каждой транзакции содержит себе номер оконечной точки endpoint на устройстве при подключении устройства драйверы ядре ос читают устройства список оконечных точек создают управляющие структуры данных для общения каждой оконечной точкой устройства совокупность оконечной точки структур данных ядре ос называется каналом pipe оконечные точки значит каналы относятся одному из классов поточный bulk управляющий control изохронный isoch прерывание interrupt низкоскоростные устройства такие как мышь не могут иметь изохронных поточных каналов управляющий канал предназначен для обмена устройством короткими пакетами вопрос ответ любое устройство имеет управляющий канал который позволяет программному обеспечению ос прочитать краткую информацию об устройстве том числе коды производителя модели используемые для выбора драйвера список других оконечных точек канал прерывания позволяет доставлять короткие пакеты том другом направлении без получения на них ответа подтверждения но гарантией времени доставки пакет будет доставлен не позже чем через миллисекунд например используется устройствах ввода клавиатуры мыши джойстики изохронный канал позволяет доставлять пакеты без гарантии доставки без ответов подтверждений но гарантированной скоростью доставки пакетов на один период шины кгц low full speed кгц high speed используется для передачи аудио видеоинформации поточный канал даёт гарантию доставки каждого пакета поддерживает автоматическую приостановку передачи данных по нежеланию устройства переполнение или опустошение буфера но не даёт гарантий скорости задержки доставки используется например принтерах сканерах время шины делится на периоды начале периода контроллер передаёт всей шине пакет начало периода далее течение периода передаются пакеты прерываний потом изохронные требуемом количестве оставшееся время периоде передаются управляющие пакеты последнюю очередь поточные активной стороной шины всегда является контроллер передача пакета данных от устройства контроллеру реализована как короткий вопрос контроллера длинный содержащий данные ответ устройства расписание движения пакетов для каждого периода шины создаётся совместными усилиями аппаратуры контроллера по драйвера для этого многие контроллеры используют крайне сложный dma со сложной dma программой формируемой драйвером размер пакета для оконечной точки есть вшитая таблицу оконечных точек устройства константа изменению не подлежит он выбирается разработчиком устройства из числа тех что поддерживаются стандартом usb версии спецификации список спецификаций спецификация скорость стандарт usb low speed до мбит usb full speed до мбит usb high speed до мбит usb superspeed до гбит usb usb gen superspeed gbps до гбит usb gen superspeed gbps до гбит usb gen предварительные версии usb спецификация выпущена ноябре года usb спецификация выпущена декабре года usb спецификация выпущена апреле года usb спецификация выпущена августе года usb release candidate спецификация выпущена ноябре года usb спецификация выпущена января года технические характеристики два режима работы режим низкой пропускной способностью low speed мбит режим высокой пропускной способностью full speed мбит максимальная длина кабеля без экрана для режима low speed максимальная длина кабеля экране для режима full speed максимальное количество подключённых устройств включая размножители возможно подключение разноскоростных периферийных устройств одному контроллеру usb напряжение питания для периферийных устройств максимальный ток потребляемый периферийным устройством ма usb спецификация выпущена сентябре года исправлены проблемы ошибки обнаруженные версии первая версия получившая массовое распространение usb логотип hi speed usb спецификация выпущена апреле года usb отличается от usb введением режима high speed пометка на логотипе hi speed для устройств usb три режима работы low speed кбит клавиатуры мыши джойстики геймпады full speed мбит аудио видеоустройства high speed мбит видеоустройства устройства хранения информации последующие модификации последующие модификации спецификации usb публикуются рамках извещений об инженерных изменениях ecn самые важные из модификаций ecn представлены наборе спецификаций usb доступном на сайте usb implementers forum mini connector ecn извещение выпущено октябре года errata начиная декабря извещение выпущено декабре года pull up pull down resistors ecn извещение выпущено мае года errata начиная мая извещение выпущено мае года interface associations ecn извещение выпущено мае года были добавлены новые стандарты позволяющие ассоциировать множество интерфейсов одной функцией устройства rounded chamfer ecn извещение выпущено октябре года unicode ecn извещение выпущено феврале года данное ecn специфицирует что строки закодированы использованием utf le inter chip usb supplement извещение выпущено марте года on the go supplement извещение выпущено декабре года usb on the go делает возможным связь двух usb устройств друг другом без отдельного usb хоста на практике одно из устройств играет роль хоста для другого usb otg логотип usb otg usb одно устройство всегда хост другое периферия смартфонам цифровым фотоаппаратам прочим мобильным устройствам приходится быть то хостом то периферией при подключении компьютеру фотоаппарат периферия при подключении фотопринтеру хост usb otg аббр от he сделал возможными такие устройства двойного назначения они сами определяют кем им быть otg устройства можно подключать компьютеру таким устройствам через тот же порт можно подключать usb периферию обычно флеш накопители цифровые фотоаппараты клавиатуры мыши другие устройства не требующие дополнительных драйверов ранг устройства определяется кабелем со стороны хоста замыкаются контакты id ground штекере со стороны периферии id никуда не подключается usb the superspeed usb logo окончательная спецификация usb появилась году созданием usb занимались компании intel microsoft hewlett packard texas instruments nec nxp semiconductors спецификация usb повышает максимальную скорость передачи информации до гбит что на порядок больше мбит которые может обеспечить usb таким образом скорость передачи возрастает мб мб эффективных до мб версия отличается не только более высокой скоростью передачи информации но увеличенной силой тока ма до ма таким образом от одного порта можно запитывать большее количество устройств также отпадает необходимость использования внешнего питания для некоторых устройств спецификации usb разъёмы кабели обновлённого стандарта физически функционально совместимы usb причём для однозначной идентификации разъёмы usb принято изготавливать из пластика синего цвета некоторых производителей красного цвета кабель usb содержит себе четыре линии пару для приёма передачи данных плюс ноль питания разъём имеет контакта для передачи superspeed сигналов usb добавлено ещё четыре линии связи две витые пары один контакт сигнальной земли gnd_drain результате чего кабель стал гораздо толще новые контакты разъёмах usb расположены отдельно от старых другом контактном ряду октябре года появилась информация от ee times со ссылкой на сотрудника одной из крупнейших компаний по производству персональных компьютеров что корпорация intel решила повременить внедрением поддержки usb свои чипсеты до года это решение привело тому что до года данный стандарт не стал массовым так как пользователю было недостаточно просто купить материнскую плату был необходим дополнительный адаптер обеспечивает аппаратную поддержку потоков для команд статусов входящих исходящих данных что позволяет более полно использовать пропускную способность usb шины потоки были добавлены протоколу usb superspeed для поддержки uasp linux поддерживает usb начиная версии ядра windows интерфейс usb поддерживается без установки дополнительных драйверов usb июля года usb promoter group объявила принятии спецификации следующего интерфейса usb скорость передачи которого может достигать гбит компактный разъём usb type используемый данной версией является симметричным позволяя вставлять кабель любой стороной как это ранее сделала apple разъёмах lightning пользователи получили возможность передавать данные со скоростью до гбит после выхода стандарта usb организация usb if объявила что режим передачи usb со скоростью до гбит superspeed теперь будут как usb gen новый стандарт передачи usb со скоростью до гбит superspeed как usb gen usb входит два стандарта superspeed usb gen со скоростью до гбит такой же как usb superspeed usb gen со скоростью до гбит удвоенная usb usb gen помимо увеличения скорости до гбит были снижены издержки кодирования до переходом на схему кодирования стандарт usb обратно совместим usb usb на практике первая реализация usb виде ip блока от synopsys показала декабре года эффективную скорость передачи гбит мб секунду usb сентября некоммерческая организация usb implementers forum usb if опубликовала спецификацию стандарта usb новая спецификация предусматривает удвоение максимально возможной скорости передачи данных по сравнению usb gen до гбит за счёт использования двух линий на гбит или гбит современные кабели usb type имеющиеся наличии уже поддерживают такой двухлинейный режим так что покупать новые кабели не придётся появление первых коммерческих устройств поддержкой стандарта usb ожидается не ранее второй половины года inter chip usb ic usb high speed inter chip usb hsic упрощённые версии usb для соединения микросхем одном устройстве упрощение достигается за счёт замены физического уровня usb асинхронного на синхронный отказа от возможности смены скорости определения подключения отказа от электрической защиты драйверов уменьшения их мощности логическая часть usb неизменна том числе логика состояний шины ic usb определяет соединение full speed мб устройств hsic определяет соединение high speed мб устройств первая версия стандарта ic usb была принята году первая версия стандарта hsic была принята году hsic использует две цифровых линии логическими уровнями lvcmos вольта strobe data максимальная длина проводников см синхронный интерфейс обеспечивает пропускную способность мбит при тактовой частоте мгц драйвер физического уровня hsic потребляет на меньше энергии занимает на меньше места на кристалле чем традиционный драйвер usb году была принята первая версия спецификаций inter chip usb для usb wireless usb логотип usb wireless wireless usb технология usb официальная спецификация доступна мая года позволяющая организовать беспроводную связь высокой скоростью передачи информации до мбит на расстоянии метров до мбит на расстоянии метров июля года usb if объявила сертификации шести первых потребительских продуктов поддержкой wireless usb media agnostic usb году была представлена спецификация ma usb позволяющая инкапсуляцию usb протокола существующие каналы связи включая wifi wigig кабели разъёмы usb кабели разъёмы usb спецификация два типа разъёмов на стороне контроллера или концентратора usb на стороне периферийного устройства впоследствии были разработаны миниатюрные разъёмы для применения usb переносных мобильных устройствах получившие название mini usb новая версия миниатюрных разъёмов называемых micro usb была представлена usb if января года обычный mini micro тип мм center мм center мм center тип мм center мм center мм center подключение выносной колодки парой разъёмов usb на материнской плате asus se существуют также разъёмы типа mini ab micro ab которыми соединяются соответствующие коннекторы как типа так типа производителями электроники используется разъём совместимый mini usb содержащий контактов не как оригинале контактный штекер не войдёт контактный разъём частности данное гнездо можно увидеть телефонах под маркой alcatel tcl fly philips где дополнительные контакты используются для возможности использования гарнитуры микрофоном однако после перехода на micro usb mini jack рамках европейской программы по стандартизации зарядных устройств использование данного разъёма года резко сократилось usb удачно сочетает долговечность механическую прочность несмотря на отсутствие винтовой затяжки однако уменьшенные варианты разъёмов имеющие тонкие пластмассовые выступы высоко выступающие из подложки гнезда плохо переносят частое смыкание размыкание требуют более бережного обращения сигналы usb версии передаются по двум проводам экранированного кабеля стандартные mini micro usb вилки белые участки пустые размещение проводников распиновка тип номер контакта обозначение цвет провода описание vbus красный или оранжевый белый или золотой данные зелёный данные gnd чёрный или синий земля распиновка mini micro номер контакта обозначение цвет провода описание vbus красный белый данные зелёный данные id on the go id определяет конец кабеля хост подключён земле устройство не подключён gnd чёрный земля здесь gnd цепь корпуса для питания периферийных устройств vbus вольт также для цепей питания данные передаются дифференциально по проводам diff diff соответственно терминологии официальной документации состояния определяются по разности потенциалов между линиями более при условии что на одной из линий случае diff при diff потенциал относительно gnd выше способ передачи является основным но не единственным например при инициализации устройство сообщает хосту режиме поддерживаемом устройством или подтягиванием одной из линий данных v_bus через резистор ком для режима low speed для режимов full speed high speed для соблюдения достаточного уровня сигнала кабеле недопускания его затухания требуется коррелировать длину кабеля сечением проводников принята практика указания толщины сечения провода awg например awg примерное соответствие маркировка кабеля указание толщины провода awg соответствующая ей длина кабеля awg длина не больше см ограничения длины кабеля также связаны задержкой сигнала линии спецификациях usb оговорена величина задержки она должна быть менее наносекунды на метр для кабеля длиной максимально допустимая задержка сигнала линии микросекунды для режима таким образом для обеспечения режима hi speed линия должна гарантировать задержку менее наносекунд low speed микросекунды кабели разъёмы usb их совместимость usb все разъёмы usb имеющие возможность входить соединение друг другом рассчитаны на совместную работу также это достигается за счёт электрической совместимости всех контактов разъёма usb контактами разъёма usb при этом разъём usb имеет дополнительные контакты не имеющие соответствия разъёме usb следовательно при соединении разъёмов разных версий лишние контакты не будут задействованы обеспечивая нормальную работу соединения версии все гнёзда штекеры между usb тип usb тип рассчитаны на совместную работу размер гнезда usb тип несколько больше чем это могло бы потребоваться для штекера usb тип более ранних при этом предусмотрено подключение эти гнёзда такого типа штекеров соответственно для подключения компьютеру периферийного устройства разъёмом usb тип можно использовать кабели обоих типов но для устройства разъёмом usb тип только кабель usb гнёзда esatap обозначенные как esata usb combo то есть имеющие возможность подключения ним штекера usb имеют возможность подключения штекеров usb тип usb usb но скоростном режиме usb штекер esata ни какую версию простого гнезда usb войти не может штекер esata может подключаться гнезду esata usb combo изображения разъёмов usb обычный mini micro тип center тип center center center тип center расположение выводов соединителей usb типа контакта micro vbus vcc vbus vcc vbus vcc gnd gnd id stda_sstx stda_sstx gnd stda_sstx stda_sstx stda_sstx gnd_drain gnd_drain stda_sstx stda_ssrx stda_ssrx gnd_drain stda_ssrx stda_ssrx stda_ssrx stda_ssrx экран экран экран экран расположение контактов вилки usb micro также существуют разъёмы usb micro ещё двух типов вилка usb micro розетка usb micro ab визуально отличаются от usb micro прямоугольной не срезанной частью разъёма секцией usb что позволяет избежать подключения вилки micro розетку micro розетку micro ab делает совместимой обеими вилками розетка micro ab будет применяться мобильных устройствах имеющих бортовой usb host контроллер для идентификации режима хост клиент используется вывод id вилке micro он замкнут на землю расположение выводов соединителей usb powered новый разъём usb powered спроектирован использованием двух дополнительных контактов что позволяет устройствам предоставлять до ма другому устройству например адаптеру wireless usb это позволяет избежать необходимости источнике питания для устройства подключаемого wireless usb адаптеру делая ещё один шаг идеальной системе беспроводной связи без отдельного питания при обычных проводных подключениях хосту или хабу эти два дополнительных контакта не используются дополнительные контакты питания розетки usb powered vbus питание usb usb данные usb gnd земля stda_ssrx superspeed приём stda_ssrx superspeed приём gnd_drain земля stda_sstx superspeed передача stda_sstx superspeed передача dpwr дополнительное питание на устройство gnd_d земля питания устройства usb type разъём usb type назначение контактов разъёме usb type контакт название описание контакт название описание gnd общая земля gnd общая земля sstxp superspeed пара tx positive ssrxp superspeed пара rx positive sstxn superspeed пара tx negative ssrxn superspeed пара rx negative vbus линия питания vbus линия питания cc канал sbu полоса пропускания данных sbu dp usb пара position positive dn usb пара position negative dn usb пара position negative dp usb пара position positive sbu полоса пропускания данных sbu cc канал vbus bus power vbus bus power ssrxn superspeed пара rx negative sstxn superspeed пара tx negative ssrxp superspeed пара rx positive sstxp superspeed пара tx positive gnd общая земля gnd общая земля разъёме usb пара подключается только одном положении положение физически не присутствует разъёме назначение проводников кабеле usb type разъём кабеля type кабель type разъём кабеля type контакт название цвет оболочки проводника название описание контакт название оплётка экран оплётка кабеля экран внешняя оплётка кабеля оплётка экран gnd луженый gnd_pwrrt gnd_pwrrt общая земля gnd vbus красный pwr_vbus pwr_vbus vbus питание vbus vconn жёлтый pwr_vconn vconn питание vconn cc синий cc канал cc dp белый utp_dp пара positive dp dn зелёный utp_dn пара negative dn sbu красный sbu_a полоса передачи данных sbu sbu чёрный sbu_b полоса передачи данных sbu sstxp жёлтый sdpp экранированная пара positive ssrxp sstxn коричневый sdpn экранированная пара negative ssrxn ssrxp зелёный sdpp экранированная пара positive sstxp ssrxn оранжевый sdpn экранированная пара negative sstxn sstxp белый sdpp экранированная пара positive ssrxp sstxn чёрный sdpn экранированная пара negative ssrxn ssrxp красный sdpp экранированная пара positive sstxp ssrxn синий sdpn экранированная пара negative sstxn цвета для оболочки проводников не установлены стандартом оптические кабели usb году некоторыми компаниями были представлены оптические оптоволоконные кабели usb thunderbolt по которым сигнал usb может передаваться на расстояние до метров против метров как правило для стандартных проводных кабелей тонкие гибкие кабели позволяют передавать данные на скоростях до гб но не обеспечивают передачу электропитания начале пути сигнал из обычного электрического сигнала usb преобразуется оптические сигналы конце пути сигнал подвергается обратному преобразованию метод связи спецификация usb предлагает разработчику несколько вариантов устройств зависимости от требуемой скорости обмена данными это low speed физическая скорость мбит full speed мбит high speed мбит superspeed гбит superspeed гбит low full high speed устройства используют одну полудуплексную линию связи для обмена данными superspeed несколько протоколы обмена идентичны usb представляет из себя сеть одним мастером хостом произвольным количеством подчинённых устройств device топология сети активное дерево активное означает что каждом узле дерева находится специальное устройство концентратор хаб хаб занимается электрическим согласованием кабелей маршрутизацией пакетов обнаружением подключения отключения устройств другими функциями все соединения сети электрически протокольно идентичны usb позволяет выполнять горячее подключение отключение отдельных устройств или сегментов сети горячее означает что работа сети при этом не нарушается мастер способен определять факт изменения конфигурации сети автоматически реальном времени поскольку вся сеть получает электропитание от мастера то поддерживается возможность автоматического контроля энергоснабжения сети устройство сообщает мастеру своих потребностях мастер может запретить работу устройства если энергетические возможности сети могут быть превышены физический уровень линия связи виде витой пары проводов импедансом ом схемотехника портов usb full high speed устройство low speed отличается подключением резистора вместо осциллограмма пакета nack для full speed устройства упрощённая электрическая схема usb соединения показана на рисунке когда хосту никто не подключён обе сигнальные линии подтянуты резисторами ком минусу питания при подключении устройства одна из линий подтягивается через резистор ком устройства low speed подтягивают линию устройства full speed таким образом хост определяет факт подключения тип подключённого устройства устройства high speed момент подключения работают как full speed переключаясь режим после обмена визитками состояние дифпары определённое резисторами подтяжки спецификации именуется idle то же состояние при включённом драйвере обозначается буквой противоположное ему состояние буквой замыкание обеих линий на минус именуется single ended сокращенно se замыкание на плюс se данные кодируются по методу nrzi non return to zero inverted по этому методу каждому нулевому биту входных данных соответствует изменение состояния дифпары или при единице изменения нет чтобы исключить потерю синхронизации на длительных единичных применяют битстаффинг то есть принудительно вставляют поток данных ноль на каждые единиц подряд состояние шины se дольше мс трактуется устройством как сброс reset требует от устройства реинициализации usb стека состояние idle дольше мс подряд трактуется устройством как останов шины suspend формально требует от устройства самоограничения потреблении электроэнергии от шины usb выход из suspend происходит либо по возобновлению активности хоста либо устройство может при необходимости подать специальный сигнал resume сигнал resume состоит из состояния на несколько миллисекунд завершаемое se se где каждое состояние длится один битовый интервал согласно скоростному режиму устройства структура пакетов обмен происходит короткими пакетами каждый пакет начинается start of packet для low full speed это kjkjkjkk далее всегда идёт специальный идентификатор пакета pid указывающий на тип пакета всего имеется разных типов пакетов поэтому pid имеет размерность бита однако для надёжности значение этого поля дублируется инверсном виде поэтому длина поля pid пакете бит заканчивается пакет end of packet se se минимальный межпакетный интервал мкс для full speed зависимости от типа пакета между pid eop может содержаться ряд других полей параметрами пакета или данными все эти поля включая pid передаются младшим битом вперёд lsb first типы пакетов usb представлены таблице типы пакетов usb тип значение pid старшим битом вперед передаваемый байт младшим битом вперед имя описание зарезервировано token out хост уведомляет устройство что следующий пакет будет содержать данные от хоста устройству in хост уведомляет устройство что готов принять от устройства пакет данными sof пакет отмечающий начало временно го фрейма или микрофрейма setup хост уведомляет устройство что следующий пакет будет содержать данные от хоста устройству split usb high speed разделённая передача ping проверка возможности приёма данных устройством usb high speed special pre уведомление хабу что следующая транзакция будет осуществляться режиме low speed handshake err ошибка разделённой передачи usb high speed ack подтверждение приёма пакета данными nack неготовность обслужить предыдущий пакет пакет игнорируется nyet данные ещё не готовы usb high speed stall предыдущий пакет обратился несуществующему или выключенному функционалу data data чётный пакет данными data нечётный пакет данными data пакет данных для изохронной передачи usb high speed mdata пакет данных для изохронной передачи usb high speed пакеты типа in out setup являются заголовками многопакетной транзакции обменом данными они содержат поля адреса устройства номера конечной точки endpoint устройстве которым будет обмен данными этой транзакции целостность пакетов удостоверяет поле crc пакеты типа data содержат поле данных поле контроля целостности данных crc стандарт ограничивает максимальную разрешённую длину данных байт для устройств байта для устройств low speed байта для устройств full speed байта для устройств high speed устройство может установить свою максимальную длину данных меньшую разрешённой хост обязан поддерживать максимальную разрешённую длину данных при обычном обмене пакеты данными чередуются как чётный нечётный пакеты типа ack nack stall завершают транзакцию сообщая не успешности текущей транзакции не содержат дополнительные поля адрес usb является сетью то есть одному хосту может подключаться несколько устройств каждому устройству процессе начального момент подключения назначается уникальный адрес размерность адреса бит нулевое значение зарезервировано соответственно одному хосту может подключаться до устройств поле адреса содержат только те пакеты что начинают транзакцию in out setup endpoint помимо адресации физически подключённых устройств usb предлагает логическую адресацию внутри устройства логическая адресация позволяет разделить потоки данных по разному функционалу внутри одного устройства например клавиатура тачпадом может иметь один канал данных для нажатий клавиш другой для данных тачпада стеке tcp ip имеется прямая аналогия конечной точки порты поле endpoint имеет размерность бита то есть возможны до точек каждая точка может независимо работать как приёмная как передающая поэтому иногда их насчитывают поле endpoint является частью адресации сети usb содержатся только тех же пакетах где есть адрес in out setup момент подключения рамках начального устройство обязано передать хосту информацию задействованных точках их назначении эта информация должна согласовываться каналами данных программного драйвера устройства хоста обращение точке вызывает ответ stall пакеты setup могут приходить только на нулевой endpoint временны фреймы спецификация usb содержит понятия временны фреймов микрофреймов для low full speed устройств каждую миллисекунду хост передаёт специальный пакет sof start of frame отмечающий начало очередного фрейма для high speed этот пакет передаётся каждые мкс такой период называется микрофрейм спецификация usb требует чтобы поддерживалось такое планирование транзакций пакетов чтобы периодичность рассылки sof не нарушалась принципы обмена данными обмен данными происходит так называемыми транзакциями неразрывными из нескольких пакетов инициатором обмена всегда является хост он передаёт короткий пакет token уведомляющий начале новой транзакции этом пакете токене хост указывает направление транзакции in или out адрес устройства номер endpoint например токен out означает что немедленно за токеном последует пакет данными от хоста устройству data или data пакетов данными может быть несколько одной транзакции если каждый из них имеет максимально допустимую для этого устройства длину данных окончание пересылки данных определяется по длине пакета не равной максимальной как только приходит укороченный пакет устройство немедленно передаёт ответный пакет подтверждение handshake например ack всё успешно принято nack не смог принять например переполнен входной буфер stall данные адресованы отключённому endpoint все пакеты транзакции передаются практически слитно максимальная пауза между пакетами не должна превышать мкс для full speed иначе транзакция будет признана ошибочной аналогично происходит передача данных от устройства хосту хост инициирует передачу токеном in если устройство не имеет готовых данных для передачи то отвечает nack транзакция заканчивается если данные готовы устройство начинает передавать пакеты data data принцип окончания передачи аналогичен неполная длина пакета данными получив неполный пакет хост отвечает устройству пакетом подтверждением ack транзакция токеном setup полностью аналогична транзакции out отличия лишь логике восприятия данных устройством это параметры соединения которые управляют работой usb стека устройства control interrupt bulk isochronous спецификация usb предоставляет несколько методов обмена данными каждому включённому endpoint должен быть сопоставлен какой либо из методов control interrupt bulk используют протокол обмена подтверждениями описанный чуть выше метод bulk позволяет хосту свободно обмениваться данными устройством по своему усмотрению метод control аналогичен bulk но обменивается устройством только специальными данными управляющими работой usb протокола соответствии со спецификацией рамках транзакций типа setup поскольку периферийные устройства не могут инициировать обмен то для передачи внезапно возникающих устройства данных придумали метод interrupt который позволяет опрашивать устройство заданным периодом метод interrupt широко применяется для опроса клавиатур мышек особняком стоит метод isochronous позволяющий зарезервировать часть полосы пропускания usb шины для таких данных как аудио или видео isochronous не поддерживает контроля целостности передачи пакеты ack nack не передаются значит не предусмотрены повторы случае ошибок неверно принятые данные пропадают инициализация устройств момент подключения хост запрашивает устройства ряд сведений дескрипторов на основании которых принимает решение как этим устройством работать дескрипторы содержат сведения производителе типе устройства на основании которых хост подбирает программный драйвер таблицы дескрипторов назначение полей подробно описаны главе спецификации usb после этого хост производит смену скорости если устройство high speed назначает устройству адрес отладка сертификация для отладки протоколов контроля соответствия стандарту разработчиками устройств могут использоваться различные инструменты позволяющие наблюдать процессы обмена на шине эти инструменты могут быть чисто программными извлекающими события шины из драйверов usb компьютера однако такие инструменты не показывают аппаратно обрабатываемые либо ошибочные сигналы шине для всеобъемлющего независимого контроля используются аппаратные сканеры анализаторы протоколов использование аппаратного анализатора рекомендуется usb консорциумом для прохождении сертификации при подготовке выпуска приборов серийное производство формально для получения права на размещение логотипов usb на продукции необходима её сертификация на соответствие стандарту организация usb if предлагает услуги по сертификации usb устройств также поддерживает список сторонних сертифицирующих лабораторий plug and play разработчики спецификации usb уделили внимание вопросу автоматического определения usb устройств чтобы избавить пользователя от рутинных действий при подключении usb устройств для этого стандарте предусмотрено два механизма устройство сообщает хосту свои атрибуты куда входит идентификатор разработчика устройства vid идентификатор изделия pid на основании этих идентификаторов хост компьютер ищет методы работы этим устройством обычно это выражается требовании установить драйверы поставляемые разработчиком устройства устройство сообщает хосту идентификатор класса устройств рамках концепции usb разработан ряд спецификаций стандартных классов устройств рамках которых унифицирована работа устройствами определённой например широко известны устройства класса human interface device hid это мышки клавиатуры игровые манипуляторы устройства mass storage флешки дисководы для популярных классов устройств компьютерах имеются готовые драйверы поэтому подключение таких устройств происходит незаметно для пользователя помимо стандартных решений usb некоторые компании энтузиасты предлагают иные решения например среде windows популярны драйверы winusb доступным стороннему разработчику api стандартные классы устройств назначение usb устройств может определяться кодами классов которые сообщаются usb хосту для загрузки необходимых драйверов коды классов позволяют унифицировать работу однотипными устройствами разных производителей устройство может поддерживать один или несколько классов максимальное количество которых определяется количеством доступных endpoints описание кодов классов код название примеры использования примечание не задано audio звуковая карта midi communication device cdc модем сетевая карта com порт human interface device hid клавиатура мышь джойстик physical interface device pid джойстик поддержкой force feedback image веб камера сканер printer принтер mass storage device msd usb накопитель карта памяти кардридер цифровая фотокамера usb hub usb хаб ah cdc data используется совместно классом cdc bh smart card reader ccid считыватель смарт карт dh content security биометрический сканер eh video device class веб камера fh personal healthcare индикатор пульса медицинское оборудование dch diagnostic device используется для проверки совместимости usb wireless controller bluetooth адаптер efh miscellaneous activesync устройства feh application specific irda устройства режим обновления прошивки dfu ffh vendor specific на усмотрение производителя электропитание стандарте usb предусмотрена возможность снабжения подключённых устройств небольшой электрической мощностью первоначально стандарт usb допускал максимальный потребляемый устройством ток до при напряжении usb увеличил максимальный ток до при том же напряжении эти стандарты позволяют хосту контролировать потребление подключённых шине устройств для этого момент подключения инициализации устройство сообщает хосту свои энергетические потребности хост оценивает энергетические возможности этого сегмента сети разрешает или запрещает устройству работу попытках запросы энергоемких устройств году usb if принял спецификацию usb battery charging которая рамках кабельной инфраструктуры usb позволяла увеличить потребляемый устройством ток до позже была принята отдельная спецификация usb power delivery которая предусматривает гораздо большую гибкость управлении питанием usb battery charging thumb первая попытка повышенное потребление гаджетов источники питания выходным разъёмом usb привела появлению спецификации usb battery charging первая версия вышла году актуальная версия usb bc опубликована году спецификация разрешала существование специально обозначенных разъёмов usb повышенной отдачей по току до протокол начального usb дополнялся возможностью договориться расширенном потреблении конечное устройство могло увеличить потребление только после договорённости хостом также разрешались разъёмы usb не подключёнными линиями данных например на зарядных устройствах такие зарядные устройства гаджетом по замкнутым между собой контактам таким устройствам разрешалось отдавать ток до для малогабаритных потребителей электроэнергии спецификация рекомендовала разъём microusb usb power delivery новом стандарте usb power delivery концепция электропитания была значительно переработана теперь разработчики как хоста так устройства получили возможность гибко управлять питанием через шину usb решение том кто является источником кто потребителем возможностях источника кабеля принимаются ходе диалога между устройствами по отдельному каналу связи возможность что процессе диалога устройство могло потребовать хост согласиться на повышение напряжения питания целью передачи по существующей кабельной инфраструктуре больших мощностей повышенное напряжение выдавалось хостом на провод питания vusb для совместимости со старыми устройствами хост возвращал напряжение старым значениям вольт как только обнаруживал отсоединение устройства технология usb power delivery обеспечивает передачу энергии до вт этого должно хватить для любых смартфонов планшетов других гаджетов благодаря технологии при помощи обычного usb кабеля появится возможность заряжать подключать все электронные устройства от источника заряда которым может выступить смартфон ноутбук или внешний аккумулятор профили источника usb pd rev профиль вт при включении вт вт вт вт вт usb pd rev году представлена первая ревизия usb pd использовалась стандартная разъёмная кабельная инфраструктура usb управление питанием осуществлялось путём диалога между потребителем источником по независимому каналу связи организованному по проводу питания стандартного кабеля usb vbus использовалась частотная модуляция несущей мгц профили источника usb pd rev вт ток вт вт вт usb pd rev вторая ревизия стандарта вышла году вместе со спецификацией usb привязана новому разъёму type частности теперь для выделенного канала связи между источником мощности потребителем используется отдельный провод кабеле configuration сhannel также поддерживается определение типа кабеля его возможностей по передаче мощности источник менее жёстко ограничен требованиями профилей первой ревизии может гибче подходить выбору максимального тока нагрузки зависимости от располагаемой мощности usb pd rev третья ревизия ожидается выходом спецификации usb нестандартные решения питание мобильных гаджетов производители мобильных гаджетов не могли пройти мимо доступности электричества из usb розетки появилось множество устройств отбирающих ток без соблюдения требований спецификации usb при этом требуемый устройством ток заряда мог быть гораздо выше чем разрешал отдавать стандарт usb чтобы обойти это ограничение многие производители телефонов выработали свои правила определения специального блока питания зарядного устройства теперь при подключении оригинальному зарядному устройству телефон получает возможность заряжаться максимально быстро то же время при подключении стандартному usb хосту телефон выполняет рекомендации стандарта usb заряжаясь пониженным током или не заряжаясь вовсе например устройства компании apple определяют максимальный отдаваемый зарядным устройством ток по напряжению на контактах если то макс ток если то макс ток если то макс ток году usb if принимает спецификацию usb battery charging чем запускает процесс стандартизации электропитания мобильных устройств годах принимается ряд национальных международных нормативов например gsm universal charging solution китайский technical requirements and test method of charger and interface for mobile terminal equipment согласно которым зарядные устройства мобильных гаджетов должны оснащаться однотипными разъёмами розетка usb на корпусе зарядного устройства micro usb на самом гаджете идентификация зарядного устройства происходит по замкнутым контактам qualcomm quick charge сигнализация qc определённую популярность приобрели технологии компании qualcomm похожие на стандарт usb power delivery но более простые реализации было выпущено четыре совместимых друг другом версии спецификации qualcomm quick charge год предусматривала питание мало отличалось от других нестандартных решений распространения не получило qualcomm quick charge год как usb power delivery спецификация предусматривала возможность повышения напряжения питания до или после согласования между зарядным устройством гаджетом но отличие от usb power delivery метод договора был гораздо проще позволял использовать существующие кабели разъёмы usb по состоянию линий гаджет определяет что подключён зарядному устройству после чего выставляет на линии определённое напряжение соответствии желаемым напряжением питания qualcomm quick charge год спецификация дополняет qc возможностью плавной регулировки выходного напряжения диапазоне по запросу гаджета согласно спецификации usb некоторые кабеля разъёмами type могут содержать микросхему параметры кабеля поскольку эта микросхема питается от линий питания кабеля то повышение напряжения на них может оказаться фатальным как для кабеля так для подключенного оборудования связи этим применение quick charge на кабелях разъёмами type оказалось рискованным году usb if опубликовал методику тестирования кабельной инфраструктуры разъёмами type где прямо запретил управление напряжением на линии питания нестандартными методами теперь зарядные устройства quick charge разъёмом usb type не смогут получить сертификат соответствия корпорация google выпустила рекомендацию не поддерживать qc android устройствах для решения этой проблемы qualcomm обещает представить году новую ревизию спецификации quick charge qualcomm quick charge представлена ноябре года заявлена совместимость кабелями разъёмами type qualcomm quick charge представлена летом года poweredusb разъёмы poweredusb году группа производителей торгового оборудования приняла корпоративный стандарт по которому разъём usb оснащался дополнительными контактами напряжениями или током до это решение не было поддержано usb if критика разъёмы mini особенно micro usb вследствие конструктивных просчётов производителя зачастую со временем разбалтываются начинают терять контакт не имеют достаточно надёжного крепления печатной плате из за чего при интенсивной эксплуатации могут быть полностью или частично повреждены некоторых случаях гнёзда отрываются что может привести необходимости замены платы или даже приобретения нового устройства связи невозможностью нормального восстановления оторванных печатных дорожек данный недостаток наиболее проявляется малогабаритных устройствах например мобильных телефонах планшетных компьютерах электронных устройствах для чтения карманных цифровых проигрывателях протокол требует от оконечного устройства поддержания достаточно сложного стека как для непосредственно обмена по шине так для поддержания сопутствующих функций типа инициализации или ответов на служебные сообщения ввиду своей сложности разнообразности устройства зачастую аппаратно выполняют лишь базовые уровни протокола оставляя верхние на откуп программному коду это приводит заметным затратам программной памяти времени также содержит угрозу ошибок попыток избыточно упростить программный код ущерб соответствию стандарту код производителя vid выдаётся разработчику устройства лишь после бюрократической процедуры денежных затрат порядка usd дополнительно организация разработчиков стандарта usb if негативно относится перепродаже владельцами кодов производителя кодов устройств pid всё это ограничивает доступность шины для мелких производителей независимых разработчиков свободно доступные коды для устройств реализующих стандартные напр порт обмена устройство памяти или аудиоустройство создатели стандарта не предоставляют список классов подклассов устройств частями чрезмерно раздут подклассы одного уровня зачастую неравноценны содержат устаревшую как результат поддержка определённого стандартного класса зачастую требует избыточного кода не нужного для как со стороны устройства так хоста компьютера то же относится типам передаваемых пакетов часть из которых имеет скорее историческое значение несмотря на заявленную универсальность многие устройства даже принадлежащие стандартным классам большей частью требуют программной поддержки отдельных драйверов на хосте так современная операционная система windows при подключении внешнего com порта или gps навигатора которые относятся одному стандартному классу устройств требует для каждого из устройств отдельного драйвера это налагает на производителей отдельные обязанности по созданию возможно подписыванию драйверов содержит риск устройства на операционной системе другой версии по сравнению другими форматами передачи данных формат usb имеет большие латентности задержки передачи информации формате usb high speed создатели предприняли попытку для уменьшения проблем латентности но этот формат сам по себе требует наличия кабеля сопряжения что во многих случаях является избыточным дорогостоящим недостатки usb хотя теоретическая максимальная пропускная способность usb составляет мбит мб на практике обеспечить пропускную способность близкую пиковой не удаётся макс мб чаще до мб это объясняется тем что шина usb является полудуплексной для передачи данных обе стороны используется всего одна витая пара поэтому за один такт данные могут быть переданы только одну сторону соответственно для обмена данными требуется такта для сравнения шина firewire хоть обладает меньшей пиковой пропускной способностью мбит что формально на мбит мб меньше чем usb но будучи дуплексной для передачи данных используется две витые пары каждая свою сторону для обмена данными требуется такт она позволяет обеспечить бо льшую пропускную способность для обмена данными жёсткими дисками другими устройствами хранения информации связи этим разнообразные мобильные накопители уже давно упираются недостаточную практическую пропускную способность usb преимущества usb возможности передачи данных на скорости до гбит контроллер способен одновременно принимать отправлять данные полнодуплексный режим что увеличило скорость работы usb обеспечивает более высокую силу тока что упрощает подключение таких устройств как например жёсткие диски usb совместим со старыми стандартами имеется возможность подключать старые устройства новые порты устройства usb можно подключать порту usb случае достаточности электропитания но скорость работы устройства будет ограничена скоростью работы порта уязвимость августе года была реализация уязвимости устройств usb получившей название badusb некоторые usb устройства позволяют изменять микропрограмму микросхемы отвечающую за взаимодействие компьютером злоумышленник проведя реверс инжиниринг конкретного устройства может создать записать него вредоносный код этот вредоносный код может например имитируя клавиатуру произвести необходимые действия за пользователя на заражаемом компьютере или имитируя сетевое устройство изменить сетевые настройки таким образом что пользователь будет просматривать сайты интернет через подконтрольные злоумышленнику промежуточные серверы фарминг кроме того имитируя usb флеш накопитель вредоносный код может загрузить запустить на компьютере включённым автозапуском вирусную программу такой вирус может скопировать себя на другие устройства usb подключённые данный момент компьютеру заражая всё новые usb устройства веб камеры клавиатуры флеш карты др зловредное устройство usb kill подобные могут эксплуатировать другую уязвимость сразу после подключения питанию usb устройство формирует серию высоковольтных импульсов на контакты данных уничтожая ценные микросхемы внутри компьютера уязвимость возникает благодаря доступности гнёзд usb также из за того что на все порты usb подаётся питание вне зависимости от того какое устройство них подключают из за слабой защиты от высокого напряжения контактах подключённых микросхемам выведенных на корпус usb firewire протокол usb mass storage представляющий собой метод передачи команд scsi по шине usb имеет бо льшие накладные расходы чем соответствующий ему протокол sbp шины firewire поэтому при подключении внешнего диска или привода cd dvd по firewire удаётся достичь большей скорости передачи данных кроме того usb mass storage не поддерживался старых ос включая windows требовал установки драйвера sbp же них поддерживался изначально также старых ос windows протокол usb storage был реализован урезанном виде не позволяющем использовать функцию записи cd dvd дисков на подключённом по usb дисководе sbp никогда не имел таких ограничений шина usb строго ориентирована поэтому соединение двух компьютеров требует дополнительного оборудования соединение оборудования без компьютера например принтера сканера или же фотоаппарата принтера было определено стандартом usb otg ранее же эти реализации были завязаны на конкретного производителя шина firewire изначально не подвержена этому недостатку например можно соединить две видеокамеры интересные факты последователям одного из евангельских культов бразилии запретили пользоваться usb портами так лидер этой секты уэлдер салданья welder saldanha усмотрел эмблеме usb символ сатаны именно трезубец которым пытают души грешников аду связи этим он заявил что все кто использует usb поклоняются сатане см также thunderbolt firewire параллельные порты ввода вывода transferjet winusb usb if usb программная реализация протокола usb для atmel avr live usb примечания литература ссылки usb implementers forum inc usb specifications usb usb wireless usb обзор устройств usb usb уже разработке usb новые подробности фотографии разъёмов usb распайка разъёма usb распайка разъёма usb mini list of usb id vendors devices and interfaces обзор по usb сравнение различных интерфейсов usb по нескольким параметрам usb in nutshell выдержки из стандарта для разработчиков периферии кабели разъёмы usb megaworldltd ru usb in nutshell перевод на русский язык первое знакомство usb качестве интерфейса вжд superspeed usb faq superspeed usb вопросы ответы superspeed usb faq перевод на русский язык виды usb разъёмов штекеров точки зрения обычного пользователя pc hard ru революция интерфейсов usb type деталях взгляд электронщика что такое usb otg смартфоне планшете категория кабельные разъёмы категория сетевые протоколы